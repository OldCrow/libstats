# v0.11.0 Header Optimization Plan - Updated After Magic Number Refactoring

**Created:** 2025-08-22
**Target Version:** v0.11.0
**Branch:** v0.11.0-header-optimizations
**Estimated Duration:** 1-2 weeks
**Current IWYU Issues:** 112 (increased from 94 due to threshold_constants.h additions)

---

## üéØ Objectives

1. **Reduce compilation time by 20-35%** through systematic header cleanup
2. **Fix ~112 include issues** identified by Include What You Use (IWYU)
3. **Standardize header inclusion patterns** across the codebase
4. **Implement forward declarations** where appropriate
5. **Create reusable header modules** to reduce duplication

---

## üìä Current State Analysis

### Post Magic Number Refactoring Status:
- **Added `threshold_constants.h`** to gamma.cpp, uniform.cpp, discrete.cpp, poisson.cpp
- **IWYU issues increased** from 94 to 112 due to new includes
- **Constants are now properly organized** but header dependencies need optimization

### Most Common Issues (from latest IWYU scan):
1. **Over-inclusion of monolithic headers**:
   - `core/constants.h` still being included when granular headers available
   - New `threshold_constants.h` may be pulling in unnecessary dependencies

2. **Missing granular includes**:
   - Missing `<stdint.h>` for integer types
   - Missing `<stddef.h>` for `size_t`
   - Missing specific mathematical constant headers

3. **Platform-specific include issues**:
   - `__vector/vector.h` appearing instead of `<vector>` (macOS specific)
   - `__math/exponential_functions.h` instead of `<cmath>` components

---

## üìù Immediate Task Breakdown

### Phase 1: Fix Granular Constant Headers (Day 1)

Since constants are already split (mathematical_constants.h, threshold_constants.h, etc.), we need to:

#### Task 1.1: Audit Current Constant Header Usage
- [ ] Review all files currently including `core/constants.h`
- [ ] Replace with specific granular headers where possible
- [ ] Update files that recently got `threshold_constants.h` to use minimal includes

**Files to update immediately:**
```bash
src/simd_dispatch.cpp     # Remove constants.h, use mathematical_constants.h
src/validation.cpp         # Remove constants.h, use specific headers
src/simd_fallback.cpp      # Use granular constant headers
src/simd_sse2.cpp         # Use specific constant headers
```

#### Task 1.2: Create Missing Granular Headers
We already have threshold_constants.h, but need to ensure clean separation:

- [ ] Verify `mathematical_constants.h` exists and is properly used
- [ ] Verify `precision_constants.h` exists and is properly used
- [ ] Verify `statistical_constants.h` exists and is properly used
- [ ] Ensure `essential_constants.h` exists for core integer constants

### Phase 2: Fix Distribution Files (Day 2-3)

#### Task 2.1: Clean Up Recent threshold_constants.h Additions
Files that now include threshold_constants.h:
- [ ] `src/gamma.cpp` - Ensure only needed constants are included
- [ ] `src/uniform.cpp` - Minimize header dependencies
- [ ] `src/discrete.cpp` - Use forward declarations where possible
- [ ] `src/poisson.cpp` - Clean up redundant includes

#### Task 2.2: Remove Unused Headers
Based on IWYU analysis:
- [ ] Remove `<algorithm>` from files not using it
- [ ] Remove unused C++20 headers from Gaussian
- [ ] Clean up redundant math includes

### Phase 3: Platform-Specific Fixes (Day 3-4)

#### Task 3.1: Fix macOS-Specific Include Issues
The IWYU output shows macOS internal headers being suggested:
- [ ] Replace `__vector/vector.h` suggestions with proper `<vector>`
- [ ] Replace `__math/exponential_functions.h` with `<cmath>`
- [ ] Add proper IWYU pragmas for platform-specific cases

#### Task 3.2: Add IWYU Pragmas
```cpp
// For headers that IWYU incorrectly suggests removing:
#include <vector>  // IWYU pragma: keep

// For forward declarations that should be exported:
namespace libstats {  // IWYU pragma: export
    class DistributionBase;
}
```

---

## üîß Implementation Plan for Today

### Step 1: Baseline Measurement (30 minutes)
```bash
# Current compilation time
time cmake --build build --clean-first --parallel 8

# Current IWYU issue count
./scripts/run-iwyu.sh --src 2>/dev/null | grep "should" | wc -l

# Save detailed IWYU report
./scripts/run-iwyu.sh --src > iwyu_baseline_$(date +%Y%m%d).txt 2>&1
```

### Step 2: Fix Low-Risk Files First (2 hours)
Start with SIMD files as they have clear issues and low risk:

1. **simd_dispatch.cpp**:
   - Remove `#include <algorithm>`
   - Replace `constants.h` with `mathematical_constants.h`
   - Add missing `<stdint.h>`

2. **simd_fallback.cpp**:
   - Use granular constant headers
   - Remove platform_constants.h if only using forward declarations

3. **simd_sse2.cpp, simd_avx.cpp, etc.**:
   - Similar cleanup pattern

### Step 3: Fix Distribution Headers (3 hours)
Focus on files we recently modified:

1. **gamma.cpp**:
   - Audit threshold_constants.h usage
   - Remove any constants.h if still present
   - Use forward declarations for heavy includes

2. **uniform.cpp, discrete.cpp, poisson.cpp**:
   - Similar pattern as gamma.cpp
   - Ensure minimal header dependencies

### Step 4: Validation (1 hour)
```bash
# Rebuild and test
cmake --build build --parallel 8
ctest --test-dir build --output-on-failure

# Re-run IWYU
./scripts/run-iwyu.sh --src 2>/dev/null | grep "should" | wc -l

# Measure compilation time improvement
time cmake --build build --clean-first --parallel 8
```

---

## üìà Success Metrics

### Target Improvements:
- **IWYU issues**: Reduce from 112 to < 20
- **Compilation time**: 20-35% reduction
- **Header dependencies**: Measurable reduction via include graphs
- **Test coverage**: 100% tests still passing

### Measurement Commands:
```bash
# Before and after each phase
time cmake --build build --clean-first --parallel 8 2>&1 | grep real

# IWYU issue tracking
./scripts/run-iwyu.sh --src 2>/dev/null | grep "should" | wc -l

# Header dependency analysis
find src -name "*.cpp" -exec grep -c "^#include" {} \; | awk '{sum+=$1} END {print "Average includes per file:", sum/NR}'
```

---

## üöÄ Next Steps

1. **Immediate (Now)**: Run baseline measurements
2. **Today Morning**: Fix SIMD files (Phase 1)
3. **Today Afternoon**: Fix distribution files (Phase 2)
4. **Tomorrow**: Platform-specific fixes and validation
5. **This Week**: Complete all phases and document improvements

---

## üìù Notes and Risks

### IWYU Caveats for Our Codebase:
- macOS IWYU suggests internal headers (`__vector/vector.h`) - ignore these
- Template-heavy code may get incorrect suggestions
- Forward declarations don't work for all template instantiations
- Some platform-specific includes must be preserved

### Specific Risks After Magic Number Refactoring:
- **Medium Risk**: Breaking constant access patterns if headers are incorrectly split
- **Low Risk**: Performance regression unlikely with header changes
- **Low Risk**: Platform-specific build failures on CI

### Mitigation Strategy:
1. Test locally after each file change
2. Run CI after each phase completion
3. Keep detailed IWYU reports for rollback if needed
4. Use `IWYU pragma: keep` for required but "unused" headers

---

**Status:** Ready to implement
**Priority:** High (blocking v0.11.0 release)
**Estimated completion:** 2-3 days of focused work
